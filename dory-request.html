<link rel="import" href="../polymer/polymer-element.html">

<dom-module id="dory-request">
    <template>
        <style>
            :host {
                display: block;
            }
        </style>
    </template>

    <script>
        /**
         * `dory-request`
         *
         *
         * @customElement
         * @polymer
         * @demo demo/index.html
         */
        class DoryRequest extends Polymer.Element {
            static get is() {
                return 'dory-request';
            }

            static get properties() {
                return {
                    url: {
                        type: String,
                    },
                    data: {
                        type: Array,
                        notify : true,
                        value: () => {
                            return [];
                        }
                    },
                    method : {
                        type : String,
                        value : 'post'
                    },
                    from : {
                        type : Number,
                        value : 0
                    },
                    size : {
                        type : Number,
                        value : 8
                    },
                    searchFields : {
                        type : Array
                    }
                };
            }

            ready(){
                super.ready();
                this.createRequest();
            }

            createRequest(searchText,searchFields){
                let myHeaders = new Headers();
                myHeaders.append('Content-Type','application/json');

                let request = {
                    method : this.method,
                    headers : myHeaders,
                    mode : 'cors',
                    body : JSON.stringify( {
                        'size' : this.size,
                        'from' : this.from
                    })
                };

                if(searchText){
                    request.body=JSON.stringify({
                        size : this.size,
                        query:{
                            simple_query_string:{
                                fields:searchFields,
                                query: `${searchText}*`
                            }
                        }
                    });
                    this.data = [];
                }

                this._handleRequest(request);
            }

            _handleRequest(request){
                fetch(this.url,request)
                    .then(response =>{
                            if(response.status !== 200){
                                console.error('Fetch encountered an error : Error code ',response.status);
                                return;
                            }
                            response.json().then( (data) => {
                                const result = data.hits.hits;
                                const items = result.map(x => Object.assign( x._source, { id:x._id} ));
                                this.data = [...this.data, ...items];
                                return items;
                            });
                        }
                    )
                    .catch(function(err){
                        console.error('Fetch error : ',err);
                    });
            }

//            _handleResponse(e){
//                new Promise( (resolve, error) => {
//                    const response =  e.detail.response.hits;
//                    const response = e.json().valueOf().hits;
//                    console.log('Response : ',response);
//                    const result = response.hits;
//                    const total = response.total;
//                    const items = result.map( x => Object.assign( x._source, { id:x._id} ));
//                    resolve( [items, total] );
//                }).then( ([items, total]) => {
//                    this.data = [...this.data, ...items];
//                    return [items, total];
//                }).catch(function(err){console.error(err)});
//            }

            loadMoreData(){
                this.from += this.size;
                this.createRequest();
            }
        }

        window.customElements.define(DoryRequest.is, DoryRequest);
    </script>
</dom-module>